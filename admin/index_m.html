<html>

<head>

    <!-- Load ioBroker scripts and styles-->
    <link rel="stylesheet" type="text/css" href="../../css/adapter.css" />
    <link rel="stylesheet" type="text/css" href="../../lib/css/materialize.css">
    <link rel="stylesheet" type="text/css" href="../../lib/css/fancytree/ui.fancytree.min.css" />
    <link type="text/css" rel="stylesheet" href="../../lib/css/themes/jquery-ui/default/jquery-ui.min.css">
    <link rel="stylesheet" type="text/css" href="../../lib/css/iob/selectID.css" />

    <script type="text/javascript" src="../../lib/js/jquery-3.2.1.min.js"></script>
    <script type="text/javascript" src="../../lib/js/jquery-ui-1.10.3.full.min.js"></script>
    <script type="text/javascript" src="../../lib/js/jquery-ui.min.js"></script>
    <script type="text/javascript" src="../../lib/js/jquery.fancytree-all.min.js"></script>
    <script type="text/javascript" src="../../lib/js/materialize.js"></script>
    <script type="text/javascript" src="../../socket.io/socket.io.js"></script>
    <script type="text/javascript" src="../../lib/js/selectID.js"></script>
    <script type="text/javascript" src="../../js/translate.js"></script>
    <script type="text/javascript" src="../../js/adapter-settings.js"></script>
    <script type="text/javascript" src="./lib/word.js"></script>

    <!-- Load our own files -->
    <link rel="stylesheet" type="text/css" href="./lib/style.css" />
    <script type="text/javascript" src="./lib/word.js"></script>
    <script type="text/javascript" src="./lib/index_m.js"></script>
    <script type="text/javascript" src="./lib/data.js"></script>

    <script type="text/javascript">
        //##################################################################################################
        //############################################ save start ##########################################
        //##################################################################################################

        async function save(callback) {

            const actData = await createSettings(dataGlobal, 'save'); // aktuelle settings holen

            const cntr = await saveCntr(actData); // counter fuer save obj erstellen

            const result = await loopArr(cntr) // devices, messenger, etc "final" erstellen

            let resultTemp = result

            resultTemp.migration = true;

            const finalObj = resultTemp; // fertiges objekt fuer native settings

            async function saveCntr(actData) {
                // counter in die native schreiben
                let objTemp = actData;
                for (const name in actData) {
                    const cntrName = `${name}_counter`
                    objTemp[cntrName] = actData[name].cntr;
                };
                return objTemp;
            };

            async function loopArr(objCntr) {
                let objTemp = objCntr;
                for (const i in dataGlobal) {
                    const id = dataGlobal[i].name;
                    objTemp[id] = {
                        id: dataGlobal[i].ids,
                        final: await createArray(dataGlobal[i]),
                    };
                };
                return objTemp;
            };

            function createArray(obj) {

                const name = obj.name;

                let objTemp = {};
                for (const i in obj.ids) {
                    if (i !== undefined) {
                        const data = obj.ids[i];
                        if (name === 'devices') {
                            const dataTable = obj.idsTable[i]; // devices hat zwei daten arrays

                            // pr√ºfen ob data in dataTable vorhanden ist
                            // und finales 'device' objekt erstellen
                            if (data.id == dataTable.id) {
                                objTemp[data.id] = {
                                    name: data.name,
                                    type: data.type,
                                    pathConsumption: data.consumption,
                                    pathSwitch: data.switch,
                                    startText: data.startText,
                                    endText: data.endText,
                                    runtimeMax: data.runtimeMax,
                                    enabled: dataTable.enabled,

                                    alexa: dataTable.alexa,
                                    sayit: dataTable.sayit,
                                    whatsapp: dataTable.whatsapp,
                                    telegram: dataTable.telegram,
                                    pushover: dataTable.pushover,
                                    email: dataTable.email,
                                    timer: dataTable.timer,

                                    autoOff: dataTable.autoOff,
                                    abort: dataTable.abort,
                                    id: dataTable.id
                                };
                            };
                        };

                        if (name === "alexa" || name === "sayit") {
                            timeMin = "";
                            timeMax = "";
                            let timeMinHourTemp = ``;
                            let timeMinMinTemp = ``;
                            let timeMaxHourTemp = ``;
                            let timeMaxMinTemp = ``;
                            if (data.timeMinHour !== `` && data.timeMinMin !== `` && data.timeMaxHour !== `` && data.timeMaxMin !== ``) {
                                timeMinHourTemp = data.timeMinHour;
                                timeMinMinTemp = data.timeMinMin;
                                timeMaxHourTemp = data.timeMaxHour;
                                timeMaxMinTemp = data.timeMaxMin;
                                timeMin = `${timeMinHourTemp}:${timeMinMinTemp}`;
                                timeMax = `${timeMaxHourTemp}:${timeMaxMinTemp}`;
                            };
                            if (data.volume < 0 || data.volume > 100 || data.volume === undefined || data.volume === '') {
                                data.volume = 50;
                            };
                        };

                        switch (name) {
                            case "alexa":
                                {
                                    objTemp[data.id] = {
                                        name: data.name,
                                        path: data.path,
                                        volume: data.volume,
                                        timeMin: timeMin,
                                        timeMax: timeMax
                                    };
                                    break;
                                };
                            case "sayit":
                                {
                                    objTemp[data.id] = {
                                        name: data.name,
                                        path: data.path,
                                        timeMin: timeMin,
                                        timeMax: timeMax,
                                        volume: data.volume
                                    };
                                    break;
                                };
                            case "whatsapp":
                                {
                                    objTemp[data.id] = {
                                        name: data.name,
                                        path: `whatsapp-cmb${data.inst}.sendMessage`,
                                    };
                                    break;
                                };
                            case "typeID":
                                {
                                    objTemp[data.id] = {
                                        name: data.name,
                                        startVal: data.startVal,
                                        endVal: data.endVal,
                                        startCount: data.startCount,
                                        endCount: data.endCount
                                    };
                                    break;
                                };
                            case "telegram":
                                {
                                    objTemp[data.id] = {
                                        name: data.nameFinal,
                                        inst: data.inst
                                    };
                                    break;
                                };
                            case "pushover":
                                {
                                    objTemp[data.id] = {
                                        name: data.name,
                                        inst: data.inst,
                                        prio: data.prio,
                                        sound: data.sound,
                                    };
                                    if (objTemp[data.id].prio == 'high') {
                                        objTemp[data.id].prio = 1;
                                    } else if (objTemp[data.id].prio == 'quiet') {
                                        objTemp[data.id].prio = -1;
                                    } else {
                                        delete objTemp[data.id].prio;
                                    };
                                    break;deviceID
                                };
                            case "email":
                                {
                                    objTemp[data.id] = {
                                        name: data.name,
                                        emailFrom: data.emailFrom,
                                        emailTo: data.emailTo
                                    };
                                    break;
                                };
                        };
                    };
                };
                return objTemp;
            };
            callback(finalObj); // daten in native settings schreiben
        };
    </script>
</head>

<body>
    <div id="gui" class="m adapter-container">
    </div>
</body>

</html>